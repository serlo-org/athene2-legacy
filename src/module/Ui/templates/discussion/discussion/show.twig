<div class="discussion-head">
    {% if discussion.getArchived() %}
        <a class="btn btn-default btn-xs pull-right archived-toggle collapsed" data-toggle="collapse" href="#collapse-{{ discussion.getId() }}">
            <span></span>
        </a>
    {% endif %}
    <strong>
        {{ discussion.getTitle() }}
    </strong>
    {% if discussion.getArchived() %}
        <small class="text-muted">
            {{ translate('archived') }}
        </small>
    {% endif %}
    <div class="mic-info">
        {{ translate('On') }} {{ normalize().toAnchor(discussion.getObject()) }}
        <!-- <small>({{ normalize().toType(discussion.getObject()) }})</small> -->
        {{ translate('by') }} {{ normalize().toAnchor(discussion.getAuthor()) }}
        <span class="glyphicon glyphicon-time"></span> {{ timeago().render(discussion.getTimestamp()) }}
    </div>
</div>
{% if discussion.getArchived() %}
    <div class="collapse" id="collapse-{{ discussion.getId() }}">
{% endif %}
<div class="discussion-text">
    {{ discussion.getContent() | nl2br }}
</div>
<div class="clearfix">
    {% if not discussion.isTrashed() %}
        <div class="discussion-action btn-group pull-right">
            {% if isGranted('discussion.vote', discussion) %}
                {% if discussion.hasUserVoted(discussion().getUser()) %}
                    {% set vote = 'down' %}
                    {% set button = 'success' %}
                {% else %}
                    {% set vote = 'up' %}
                    {% set button = 'default' %}
                {% endif %}
                <a href="{{ url('discussion/discussion/vote', {'comment': discussion.getId(), 'vote': vote}) }}"
                   class="btn btn-xs btn-{{ button }}">
                    <span class="glyphicon glyphicon-chevron-{{ vote }}"></span>
                    <strong>{{ discussion.countUpVotes() }}</strong> </a>
            {% else %}
                <button class="btn btn-default btn-xs" disabled>
                    <span class="glyphicon glyphicon-chevron-up"></span>
                    <strong>{{ discussion.countUpVotes() }}</strong>
                </button>
            {% endif %}
            {% if isGranted('discussion.archive', discussion) %}
                <a href="{{ url('discussion/discussion/archive', {'comment': discussion.getId()}) }}"
                   class="btn btn-xs btn-default">
                    <span class="glyphicon glyphicon-{{ discussion.getArchived() ? 'refresh' : 'ok' }}"></span> </a>
            {% endif %}
            {% if isGranted('flag.create', discussion) %}
                <a class="btn btn-xs btn-default" href="{{ url('flag/add', {'id': discussion.getId()}) }}">
                    <span class="glyphicon glyphicon-flag"></span> </a>
            {% endif %}
            {% if isGranted('discussion.trash', discussion) %}
                <a href="{{ url('uuid/trash', {'id': discussion.getId()}) }}"
                   class="btn btn-xs btn-default dialog"
                   data-content="{{ translate('Do you really want to delete this discussion?') }}">
                    <span class="glyphicon glyphicon-trash"></span> </a>
            {% endif %}
        </div>
    {% endif %}
</div>
<ul class="list-group discussions">
    {% for comment in discussion.getChildren() if not comment.isTrashed() %}
        <li class="list-group-item">
            <div class="discussion-head">
                <div class="mic-info">
                    {{ translate('by') }} {{ normalize().toAnchor(comment.getAuthor()) }}
                    <span class="glyphicon glyphicon-time"></span> {{ timeago().render(comment.getTimestamp()) }}
                </div>
            </div>
            <div class="discussion-text">
                {{ comment.getContent() | nl2br }}
            </div>
            <div class="clearfix">
                <div class="discussion-action btn-group pull-right">
                    {% if isGranted('flag.create', discussion) %}
                        <a class="btn btn-xs btn-default"
                           href="{{ url('flag/add', {'id': discussion.getId()}) }}">
                            <span class="glyphicon glyphicon-flag"></span> </a>
                    {% endif %}
                    {% if isGranted('discussion.comment.trash', discussion) %}
                        <a href="{{ url('uuid/trash', {'id': discussion.getId()}) }}"
                           class="btn btn-xs btn-default dialog"
                           data-content="{{ translate('Do you really want to delete this comment?') }}">
                            <span class="glyphicon glyphicon-trash"></span> </a>
                    {% endif %}
                </div>
            </div>
        </li>
    {% endfor %}
    {% if not discussion.getArchived() and isGranted('discussion.comment.create', discussion) %}
        <li class="list-group-item">
            <p>
                <strong>{{ translate('Answer discussion:') }}</strong>
            </p>
            {{ form().render(discussion().getForm('comment', discussion)) }}
        </li>
    {% endif %}
</ul>

{% if discussion.getArchived() %}
    </div>
{% endif %}